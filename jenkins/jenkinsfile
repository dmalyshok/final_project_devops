pipeline {
    agent {label 'docker'}

    stages {
        stage('1-Build Docker') {
            steps {
                echo "Start of Stage Build"
                echo "Building Docker Image"
                sh '''
                sudo docker stop $(sudo docker ps -aq)
                sudo docker build -t dmalyshok/apache:v${BUILD_NUMBER} -f ./docker/Dockerfile .
                sudo docker run -d -p 8080:80 dmalyshok/apache:v${BUILD_NUMBER}
                '''
                echo "Docker"
            }
        }
        stage('2-Test Run Docker') {
            steps {
                sh '''
                export status=$(curl -o /dev/null -s -w "%{http_code}\n" http://127.0.0.1:8080)
                if [ status==200 ]
                then
                exit 0
                else
                exit 1
                fi
                '''
            }
        }
        stage('3-Deploy and Run Docker') {
            steps {
                sh '''
                sudo docker save -o /home/ubuntu/apache_artifact_v${BUILD_NUMBER} dmalyshok/apache:v${BUILD_NUMBER}
                '''
            }
        }
    }
}