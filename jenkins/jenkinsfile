pipeline {
    agent {label 'docker'}

    stages {
        stage('1-Build Docker') {
            steps {
                echo "Start of Stage Build"
                echo "Building Docker Image"
                sh '''
                sudo docker stop $(sudo docker ps -aq)
                sudo docker build -t dmalyshok/apache:v${BUILD_NUMBER} -f ./docker/Dockerfile .
                sudo docker run -d -p 8080:80 dmalyshok/apache:v${BUILD_NUMBER}
                '''
                echo "Docker"
            }
        }
        stage('2-Test') {
            steps {
                sh '''
                export status=$(curl -o /dev/null -s -w "$(http_code)" http://{IP}:8080/index.html)
                if [ status==200 ]
                then
                exit 0
                else
                exit 1
                fi
                '''
            }
        }
        stage('3-Deploy') {
            steps {
                echo "Start of Stage Deploy"
                echo "Deploying......."
                //sh 'scp -r -i "/var/lib/jenkins/jenkins_dev.pub" www/* ubuntu@172.31.27.97:/var/www/html/'
                //sh 'cp www/* /var/www/html/'
                echo "End of Stage Build"
            }
        }
    }
}



// pipeline {
//     agent {label 'docker'}
//     stages {
//         stage('Test_Stage_Docker') {
//             agent any
//             // {
//             //     docker { image 'httpd' }
//             //     args '-v /var/lib/jenkins/workspace/Project_Pipeline:/var/www/html'
//             // }
//             steps {
//                 sh 'ls -la'
//             }
//         }
//         stage('Deploy_to_DEV_server') {
//             agent any

//             steps {
//                 echo "Start of Stage Deploy"
//                 echo "Deploying......."
//                 sh 'scp -r -i "/var/lib/jenkins/jenkins_dev.pub" www/* ubuntu@172.31.27.97:/var/www/html/'
//                 echo "End of Stage Build"
//             }
//         }
//     }
// }